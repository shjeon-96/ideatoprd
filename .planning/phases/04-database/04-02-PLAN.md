---
phase: 04-database
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [supabase/migrations/00002_create_prds.sql, supabase/migrations/00003_create_purchases.sql, supabase/migrations/00004_create_usage_logs.sql]
domain: supabase
---

<objective>
PRD, 구매, 사용 로그 테이블 생성

Purpose: 핵심 비즈니스 데이터 저장을 위한 테이블 구축
Output: prds, purchases, usage_logs 테이블 마이그레이션
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-database/04-RESEARCH.md
@.planning/phases/04-database/04-01-SUMMARY.md

**Constraining decisions:**
- RLS 필수 활성화
- `(select auth.uid())` 패턴 사용
- user_id 컬럼에 인덱스 필수

**PRD 데이터 구조 (from PROJECT.md):**
- 템플릿: SaaS, Mobile, Marketplace, Extension, AI-Wrapper
- 버전: basic, detailed
- 컨텐츠: JSONB로 유연한 스키마
</context>

<tasks>

<task type="auto">
  <name>Task 1: prds 테이블 마이그레이션</name>
  <files>supabase/migrations/00002_create_prds.sql</files>
  <action>
`supabase migration new create_prds` 실행 후:

```sql
-- PRD 템플릿 타입
create type public.prd_template as enum (
  'saas',
  'mobile',
  'marketplace',
  'extension',
  'ai_wrapper'
);

-- PRD 버전 타입
create type public.prd_version as enum (
  'basic',
  'detailed'
);

-- prds 테이블
create table public.prds (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,

  -- 입력
  idea text not null,
  template public.prd_template not null default 'saas',
  version public.prd_version not null default 'basic',

  -- 출력
  title text,
  content jsonb,  -- PRD 구조화된 컨텐츠

  -- 메타데이터
  credits_used integer not null default 1,
  generation_time_ms integer,  -- 생성 소요 시간

  -- 타임스탬프
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null
);

-- RLS 활성화
alter table public.prds enable row level security;

-- RLS 정책
create policy "Users can view own PRDs"
on public.prds for select
to authenticated
using ( (select auth.uid()) = user_id );

create policy "Users can create own PRDs"
on public.prds for insert
to authenticated
with check ( (select auth.uid()) = user_id );

create policy "Users can update own PRDs"
on public.prds for update
to authenticated
using ( (select auth.uid()) = user_id )
with check ( (select auth.uid()) = user_id );

create policy "Users can delete own PRDs"
on public.prds for delete
to authenticated
using ( (select auth.uid()) = user_id );

-- 성능 인덱스
create index idx_prds_user_id on public.prds using btree (user_id);
create index idx_prds_created_at on public.prds using btree (created_at desc);

-- updated_at 트리거
create trigger on_prds_updated
  before update on public.prds
  for each row execute procedure public.handle_updated_at();
```

적용: `supabase db push`
  </action>
  <verify>supabase db push 성공</verify>
  <done>prds 테이블 생성, enum 타입 정의, RLS 정책 적용</done>
</task>

<task type="auto">
  <name>Task 2: purchases 테이블 마이그레이션</name>
  <files>supabase/migrations/00003_create_purchases.sql</files>
  <action>
`supabase migration new create_purchases` 실행 후:

```sql
-- 결제 상태 타입
create type public.purchase_status as enum (
  'pending',
  'completed',
  'failed',
  'refunded'
);

-- 크레딧 패키지 타입
create type public.credit_package as enum (
  'starter',   -- 10 credits
  'basic',     -- 30 credits
  'pro',       -- 100 credits
  'business'   -- 300 credits
);

-- purchases 테이블
create table public.purchases (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,

  -- 결제 정보
  package public.credit_package not null,
  credits_amount integer not null,
  amount_cents integer not null,  -- 금액 (센트 단위)
  currency text not null default 'USD',

  -- Lemon Squeezy 정보
  lemon_squeezy_order_id text unique,
  lemon_squeezy_product_id text,
  lemon_squeezy_variant_id text,

  -- 상태
  status public.purchase_status not null default 'pending',

  -- 타임스탬프
  created_at timestamptz default now() not null,
  completed_at timestamptz
);

-- RLS 활성화
alter table public.purchases enable row level security;

-- RLS 정책: 자신의 구매 내역만 조회 가능
create policy "Users can view own purchases"
on public.purchases for select
to authenticated
using ( (select auth.uid()) = user_id );

-- INSERT는 서버에서만 (service_role 사용)
-- 클라이언트에서 직접 구매 생성 불가

-- 성능 인덱스
create index idx_purchases_user_id on public.purchases using btree (user_id);
create index idx_purchases_status on public.purchases using btree (status);
create index idx_purchases_lemon_squeezy_order_id on public.purchases using btree (lemon_squeezy_order_id);
```

적용: `supabase db push`
  </action>
  <verify>supabase db push 성공</verify>
  <done>purchases 테이블 생성, 결제 상태/패키지 enum 정의</done>
</task>

<task type="auto">
  <name>Task 3: usage_logs 테이블 마이그레이션</name>
  <files>supabase/migrations/00004_create_usage_logs.sql</files>
  <action>
`supabase migration new create_usage_logs` 실행 후:

```sql
-- 사용 유형 타입
create type public.usage_type as enum (
  'prd_generation',    -- PRD 생성
  'credit_purchase',   -- 크레딧 구매
  'credit_refund',     -- 크레딧 환불
  'signup_bonus'       -- 가입 보너스
);

-- usage_logs 테이블 (감사 추적)
create table public.usage_logs (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references public.profiles(id) on delete cascade not null,

  -- 사용 정보
  usage_type public.usage_type not null,
  credits_delta integer not null,  -- 양수: 충전, 음수: 차감
  credits_before integer not null,
  credits_after integer not null,

  -- 관련 리소스
  related_prd_id uuid references public.prds(id) on delete set null,
  related_purchase_id uuid references public.purchases(id) on delete set null,

  -- 메타데이터
  description text,
  metadata jsonb,

  -- 타임스탬프
  created_at timestamptz default now() not null
);

-- RLS 활성화
alter table public.usage_logs enable row level security;

-- RLS 정책: 자신의 사용 로그만 조회
create policy "Users can view own usage logs"
on public.usage_logs for select
to authenticated
using ( (select auth.uid()) = user_id );

-- INSERT는 서버에서만 (DB function 또는 service_role)

-- 성능 인덱스
create index idx_usage_logs_user_id on public.usage_logs using btree (user_id);
create index idx_usage_logs_created_at on public.usage_logs using btree (created_at desc);
create index idx_usage_logs_usage_type on public.usage_logs using btree (usage_type);
```

적용: `supabase db push`
  </action>
  <verify>supabase db push 성공</verify>
  <done>usage_logs 테이블 생성, 감사 추적 가능</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 모든 마이그레이션 파일 생성 (00002, 00003, 00004)
- [ ] `supabase db push` 성공
- [ ] Supabase Dashboard에서 prds, purchases, usage_logs 테이블 확인
- [ ] 모든 테이블에 RLS 활성화 확인
</verification>

<success_criteria>

- prds 테이블: JSONB content, template/version enum
- purchases 테이블: Lemon Squeezy 연동 준비
- usage_logs 테이블: 감사 추적 가능
- 모든 테이블 RLS 활성화
- user_id 인덱스 생성
</success_criteria>

<output>
After completion, create `.planning/phases/04-database/04-02-SUMMARY.md`
</output>
