---
phase: 04-database
plan: 01
type: execute
depends_on: []
files_modified: [supabase/config.toml, supabase/migrations/00001_create_profiles.sql]
domain: supabase
---

<objective>
Supabase CLI 프로젝트 링크 및 profiles 테이블 생성

Purpose: Supabase 로컬 개발 환경 설정 및 사용자 프로필 테이블 구축
Output: supabase/ 디렉토리 구조, profiles 테이블 마이그레이션
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-database/04-RESEARCH.md
@.planning/phases/03-authentication/03-04-SUMMARY.md

**Tech stack available:** @supabase/supabase-js, @supabase/ssr (Phase 3에서 설치)
**Established patterns:**
- Supabase server/client helpers (src/shared/lib/supabase/)
- Server Component auth check (AuthGuard)
- Client hook for reactive state (useUser)

**Constraining decisions:**
- Phase 3: Supabase Auth 선택 (Firebase 대신)
- RLS 필수 활성화 (CVE-2025-48757 사고 참조)
- `(select auth.uid())` 패턴으로 RLS 성능 최적화
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase 프로젝트 초기화 및 링크</name>
  <files>supabase/config.toml, .env.local</files>
  <action>
1. Supabase CLI가 설치되어 있는지 확인 (`supabase --version`)
2. 프로젝트 루트에서 `supabase init` 실행 (supabase/ 디렉토리 생성)
3. `supabase link --project-ref <project-id>` 실행
   - project-id는 .env.local의 NEXT_PUBLIC_SUPABASE_URL에서 추출
   - 형식: https://<project-id>.supabase.co
4. supabase/config.toml 확인

**주의:**
- supabase login이 필요하면 auth gate로 전환
- 로컬 DB 없이 원격 연결만 사용 (supabase start 불필요)
  </action>
  <verify>supabase status 또는 supabase db pull --dry-run 성공</verify>
  <done>supabase/ 디렉토리 생성, 프로젝트 링크 완료</done>
</task>

<task type="auto">
  <name>Task 2: profiles 테이블 마이그레이션 생성</name>
  <files>supabase/migrations/00001_create_profiles.sql</files>
  <action>
`supabase migration new create_profiles` 실행 후 생성된 파일에 아래 SQL 작성:

```sql
-- profiles 테이블: auth.users와 1:1 관계
create table public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  email text,
  display_name text,
  avatar_url text,
  credits integer default 3 not null check (credits >= 0),
  created_at timestamptz default now() not null,
  updated_at timestamptz default now() not null
);

-- RLS 활성화 (필수!)
alter table public.profiles enable row level security;

-- RLS 정책: 자신의 프로필만 조회/수정
create policy "Users can view own profile"
on public.profiles for select
to authenticated
using ( (select auth.uid()) = id );

create policy "Users can update own profile"
on public.profiles for update
to authenticated
using ( (select auth.uid()) = id )
with check ( (select auth.uid()) = id );

-- 성능 인덱스 (id는 PK라 자동 인덱스)
create index idx_profiles_email on public.profiles using btree (email);

-- 자동 프로필 생성 트리거
create or replace function public.handle_new_user()
returns trigger
set search_path = ''
as $$
begin
  insert into public.profiles (id, email, display_name, avatar_url)
  values (
    new.id,
    new.email,
    coalesce(new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'name'),
    new.raw_user_meta_data->>'avatar_url'
  );
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();

-- updated_at 자동 갱신 트리거
create or replace function public.handle_updated_at()
returns trigger
set search_path = ''
as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

create trigger on_profiles_updated
  before update on public.profiles
  for each row execute procedure public.handle_updated_at();
```

마이그레이션 적용: `supabase db push`

**핵심:**
- credits 기본값 3 (무료 크레딧)
- CHECK 제약으로 음수 방지
- OAuth 메타데이터에서 display_name, avatar_url 추출
- RLS 정책에 `(select auth.uid())` 패턴 사용 (성능)
  </action>
  <verify>supabase db push 성공, Supabase Dashboard에서 profiles 테이블 확인</verify>
  <done>profiles 테이블 생성, RLS 정책 적용, 트리거 활성화</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] supabase/ 디렉토리 존재
- [ ] supabase/migrations/00001_create_profiles.sql 존재
- [ ] `supabase db push` 성공
- [ ] Supabase Dashboard에서 profiles 테이블 확인 가능
</verification>

<success_criteria>

- Supabase 프로젝트 링크 완료
- profiles 테이블 생성 (id, email, display_name, avatar_url, credits, timestamps)
- RLS 정책 활성화 (SELECT, UPDATE)
- 회원가입 시 자동 프로필 생성 트리거
- 마이그레이션 파일 버전 관리
</success_criteria>

<output>
After completion, create `.planning/phases/04-database/04-01-SUMMARY.md`
</output>
