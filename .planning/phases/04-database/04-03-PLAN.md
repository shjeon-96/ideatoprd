---
phase: 04-database
plan: 03
type: execute
depends_on: ["04-02"]
files_modified: [supabase/migrations/00005_create_functions.sql, src/entities/database.types.ts, src/entities/index.ts, src/shared/lib/supabase/client.ts, src/shared/lib/supabase/server.ts]
domain: supabase
---

<objective>
Database functions 생성 및 TypeScript 타입 자동 생성

Purpose: 크레딧 관리 함수와 타입 안전한 Supabase 클라이언트 구축
Output: 크레딧 함수, 자동 생성된 TypeScript 타입, 타입 통합
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-database/04-RESEARCH.md
@.planning/phases/04-database/04-02-SUMMARY.md
@src/shared/lib/supabase/client.ts
@src/shared/lib/supabase/server.ts

**Constraining decisions:**
- 크레딧 차감은 원자적 트랜잭션 필요
- FOR UPDATE 락으로 동시성 문제 해결
- TypeScript 타입은 supabase gen types로 자동 생성
</context>

<tasks>

<task type="auto">
  <name>Task 1: 크레딧 관리 함수 마이그레이션</name>
  <files>supabase/migrations/00005_create_functions.sql</files>
  <action>
`supabase migration new create_functions` 실행 후:

```sql
-- 크레딧 차감 함수 (PRD 생성 시 사용)
create or replace function public.deduct_credit(
  p_user_id uuid,
  p_amount integer,
  p_prd_id uuid default null,
  p_description text default 'PRD generation'
)
returns boolean
language plpgsql
security definer
set search_path = ''
as $$
declare
  v_current_credits integer;
begin
  -- 현재 크레딧 조회 (FOR UPDATE로 락)
  select credits into v_current_credits
  from public.profiles
  where id = p_user_id
  for update;

  -- 크레딧 부족 시 실패
  if v_current_credits is null or v_current_credits < p_amount then
    return false;
  end if;

  -- 크레딧 차감
  update public.profiles
  set credits = credits - p_amount,
      updated_at = now()
  where id = p_user_id;

  -- 사용 로그 기록
  insert into public.usage_logs (
    user_id, usage_type, credits_delta,
    credits_before, credits_after,
    related_prd_id, description
  ) values (
    p_user_id, 'prd_generation', -p_amount,
    v_current_credits, v_current_credits - p_amount,
    p_prd_id, p_description
  );

  return true;
end;
$$;

-- 크레딧 충전 함수 (구매 완료 시 사용)
create or replace function public.add_credit(
  p_user_id uuid,
  p_amount integer,
  p_purchase_id uuid default null,
  p_usage_type public.usage_type default 'credit_purchase',
  p_description text default 'Credit purchase'
)
returns boolean
language plpgsql
security definer
set search_path = ''
as $$
declare
  v_current_credits integer;
begin
  -- 현재 크레딧 조회
  select credits into v_current_credits
  from public.profiles
  where id = p_user_id
  for update;

  if v_current_credits is null then
    return false;
  end if;

  -- 크레딧 충전
  update public.profiles
  set credits = credits + p_amount,
      updated_at = now()
  where id = p_user_id;

  -- 사용 로그 기록
  insert into public.usage_logs (
    user_id, usage_type, credits_delta,
    credits_before, credits_after,
    related_purchase_id, description
  ) values (
    p_user_id, p_usage_type, p_amount,
    v_current_credits, v_current_credits + p_amount,
    p_purchase_id, p_description
  );

  return true;
end;
$$;

-- 사용자 크레딧 조회 함수 (RPC)
create or replace function public.get_user_credits(p_user_id uuid)
returns integer
language plpgsql
security definer
set search_path = ''
as $$
declare
  v_credits integer;
begin
  select credits into v_credits
  from public.profiles
  where id = p_user_id;

  return coalesce(v_credits, 0);
end;
$$;
```

적용: `supabase db push`

**핵심:**
- `security definer`: 함수 소유자 권한으로 실행 (RLS 우회)
- `set search_path = ''`: 보안 best practice
- `FOR UPDATE`: 동시성 제어를 위한 행 락
  </action>
  <verify>supabase db push 성공</verify>
  <done>deduct_credit, add_credit, get_user_credits 함수 생성</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript 타입 생성 및 통합</name>
  <files>src/entities/database.types.ts, src/entities/index.ts, src/shared/lib/supabase/client.ts, src/shared/lib/supabase/server.ts</files>
  <action>
1. 타입 생성:
```bash
supabase gen types typescript --linked > src/entities/database.types.ts
```

2. src/entities/index.ts 생성 (barrel export):
```typescript
// Database types (auto-generated)
export type { Database } from './database.types'

// Convenience type aliases
import type { Database } from './database.types'

// Table row types
export type Profile = Database['public']['Tables']['profiles']['Row']
export type PRD = Database['public']['Tables']['prds']['Row']
export type Purchase = Database['public']['Tables']['purchases']['Row']
export type UsageLog = Database['public']['Tables']['usage_logs']['Row']

// Insert types
export type ProfileInsert = Database['public']['Tables']['profiles']['Insert']
export type PRDInsert = Database['public']['Tables']['prds']['Insert']
export type PurchaseInsert = Database['public']['Tables']['purchases']['Insert']
export type UsageLogInsert = Database['public']['Tables']['usage_logs']['Insert']

// Update types
export type ProfileUpdate = Database['public']['Tables']['profiles']['Update']
export type PRDUpdate = Database['public']['Tables']['prds']['Update']
export type PurchaseUpdate = Database['public']['Tables']['purchases']['Update']

// Enum types
export type PRDTemplate = Database['public']['Enums']['prd_template']
export type PRDVersion = Database['public']['Enums']['prd_version']
export type PurchaseStatus = Database['public']['Enums']['purchase_status']
export type CreditPackage = Database['public']['Enums']['credit_package']
export type UsageType = Database['public']['Enums']['usage_type']
```

3. Supabase 클라이언트에 타입 적용:

**src/shared/lib/supabase/client.ts** 수정:
```typescript
import { createBrowserClient } from '@supabase/ssr'
import type { Database } from '@/entities/database.types'

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**src/shared/lib/supabase/server.ts** 수정:
```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'
import type { Database } from '@/entities/database.types'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Server Component에서 호출 시 무시
          }
        },
      },
    }
  )
}
```

**주의:**
- tsconfig.json의 paths에 `@/entities/*` 추가 필요 시 확인
- 기존 코드와의 호환성 유지
  </action>
  <verify>npm run build 성공, 타입 에러 없음</verify>
  <done>database.types.ts 생성, 타입 안전한 Supabase 클라이언트</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Supabase 데이터베이스 스키마 및 타입 시스템</what-built>
  <how-to-verify>
    1. Supabase Dashboard 접속 (https://supabase.com/dashboard)
    2. 프로젝트 선택 후 Table Editor 확인
    3. 다음 테이블 존재 확인:
       - profiles (id, email, display_name, avatar_url, credits, timestamps)
       - prds (id, user_id, idea, template, version, title, content, timestamps)
       - purchases (id, user_id, package, credits_amount, amount_cents, status)
       - usage_logs (id, user_id, usage_type, credits_delta, timestamps)
    4. 각 테이블의 RLS 활성화 확인 (Authentication > Policies)
    5. Database > Functions에서 함수 확인:
       - deduct_credit
       - add_credit
       - get_user_credits
    6. 로컬에서 `npm run build` 성공 확인
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] 모든 마이그레이션 적용 (supabase db push)
- [ ] 5개 테이블 생성 확인 (profiles, prds, purchases, usage_logs)
- [ ] 모든 테이블 RLS 활성화
- [ ] 3개 함수 생성 (deduct_credit, add_credit, get_user_credits)
- [ ] TypeScript 타입 생성 및 통합
- [ ] `npm run build` 성공
</verification>

<success_criteria>

- 모든 데이터베이스 마이그레이션 적용
- 크레딧 관리 함수 (원자적 트랜잭션)
- TypeScript 타입 자동 생성 및 클라이언트 통합
- 타입 안전한 Supabase 쿼리 가능
- Phase 4 완료
</success_criteria>

<output>
After completion, create `.planning/phases/04-database/04-03-SUMMARY.md`

Include:
- Database schema diagram (text-based)
- Created functions list
- TypeScript type aliases
- Phase 4 completion status
</output>
