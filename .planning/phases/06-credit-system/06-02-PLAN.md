---
phase: 06-credit-system
plan: 02
title: Checkout Flow + Purchase UI
depends_on: [06-01]
parallel: false
ai_context: |
  Phase 6 두 번째 플랜: Server Action으로 Checkout URL 생성, Lemon.js Overlay 통합,
  크레딧 패키지 선택 UI 구현. 사용자가 크레딧을 구매할 수 있는 전체 결제 플로우 구축.
---

# 06-02: Checkout Flow + Purchase UI

## Overview

Server Action으로 Lemon Squeezy Checkout URL을 생성하고, Lemon.js Overlay로 결제 UI를 표시합니다. 크레딧 패키지 선택 UI와 구매 버튼을 구현합니다.

## Prerequisites

- Plan 06-01 완료 (SDK 설정, 웹훅 핸들러)

## Tasks

### Task 1: Checkout Server Action 생성

**File to create:**
- `src/features/purchase/api/create-checkout.ts`

**Implementation:**

```typescript
// src/features/purchase/api/create-checkout.ts
'use server';

import { createCheckout, lemonSqueezySetup } from '@lemonsqueezy/lemonsqueezy.js';
import { createClient } from '@/src/shared/lib/supabase/server';
import { CREDIT_PACKAGES } from '../model/credit-packages';
import type { CreditPackage } from '@/src/entities';

interface CreateCheckoutResult {
  success: true;
  checkoutUrl: string;
} | {
  success: false;
  error: string;
}

export async function createCreditCheckout(
  packageKey: CreditPackage
): Promise<CreateCheckoutResult> {
  // 1. Validate package exists
  const packageConfig = CREDIT_PACKAGES[packageKey];
  if (!packageConfig) {
    return { success: false, error: '유효하지 않은 패키지입니다.' };
  }

  if (!packageConfig.variantId) {
    return { success: false, error: '패키지 설정이 완료되지 않았습니다.' };
  }

  // 2. Get authenticated user
  const supabase = await createClient();
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    return { success: false, error: '로그인이 필요합니다.' };
  }

  // 3. Initialize Lemon Squeezy SDK
  const apiKey = process.env.LEMONSQUEEZY_API_KEY;
  const storeId = process.env.LEMONSQUEEZY_STORE_ID;

  if (!apiKey || !storeId) {
    console.error('Lemon Squeezy configuration missing');
    return { success: false, error: '결제 시스템 설정 오류입니다.' };
  }

  lemonSqueezySetup({ apiKey });

  // 4. Create checkout
  try {
    const { data, error } = await createCheckout(storeId, packageConfig.variantId, {
      checkoutOptions: {
        embed: true, // Enable overlay mode
        media: false, // Hide product media
        desc: true, // Show description
      },
      checkoutData: {
        email: user.email ?? undefined,
        custom: {
          user_id: user.id, // Pass user ID for webhook
        },
      },
      productOptions: {
        redirectUrl: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard?purchase=success`,
        receiptButtonText: '대시보드로 이동',
        receiptLinkUrl: `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`,
      },
    });

    if (error) {
      console.error('Checkout creation failed:', error);
      return { success: false, error: '결제 페이지 생성에 실패했습니다.' };
    }

    return { success: true, checkoutUrl: data.data.attributes.url };
  } catch (err) {
    console.error('Checkout error:', err);
    return { success: false, error: '결제 처리 중 오류가 발생했습니다.' };
  }
}
```

**Verification:**
- [ ] Server action 문법 확인 ('use server')
- [ ] 타입 검사 통과

---

### Task 2: Lemon.js 타입 선언

**File to create:**
- `src/shared/lib/lemon-squeezy/lemon-types.d.ts`

**Implementation:**

```typescript
// src/shared/lib/lemon-squeezy/lemon-types.d.ts

declare global {
  interface Window {
    createLemonSqueezy?: () => void;
    LemonSqueezy?: {
      Setup: (config?: { eventHandler?: (event: LemonSqueezyEvent) => void }) => void;
      Url: {
        Open: (url: string) => void;
        Close: () => void;
      };
      Refresh: () => void;
    };
  }
}

export interface LemonSqueezyEvent {
  event:
    | 'Checkout.Success'
    | 'Checkout.Cancelled'
    | 'Checkout.ViewCart'
    | 'PaymentMethodUpdate.Mounted'
    | 'PaymentMethodUpdate.Closed'
    | 'PaymentMethodUpdate.Updated';
}

export {};
```

**Verification:**
- [ ] 글로벌 타입 선언 확인

---

### Task 3: CreditPackages UI 컴포넌트

**File to create:**
- `src/features/purchase/ui/CreditPackages.tsx`

**Implementation:**

```typescript
// src/features/purchase/ui/CreditPackages.tsx
'use client';

import { CREDIT_PACKAGES, type CreditPackageConfig } from '../model/credit-packages';
import type { CreditPackage } from '@/src/entities';
import { cn } from '@/src/shared/lib/utils';
import { Check } from 'lucide-react';

interface CreditPackagesProps {
  selectedPackage: CreditPackage | null;
  onSelect: (packageKey: CreditPackage) => void;
  disabled?: boolean;
}

export function CreditPackages({
  selectedPackage,
  onSelect,
  disabled = false,
}: CreditPackagesProps) {
  return (
    <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      {(Object.entries(CREDIT_PACKAGES) as [CreditPackage, CreditPackageConfig][]).map(
        ([key, pkg]) => (
          <button
            key={key}
            onClick={() => onSelect(key)}
            disabled={disabled}
            className={cn(
              'relative flex flex-col rounded-xl border-2 p-6 text-left transition-all',
              'hover:border-primary/50 hover:shadow-md',
              'focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2',
              'disabled:cursor-not-allowed disabled:opacity-50',
              selectedPackage === key
                ? 'border-primary bg-primary/5'
                : 'border-border bg-card'
            )}
          >
            {/* Popular badge */}
            {pkg.popular && (
              <span className="absolute -top-3 left-1/2 -translate-x-1/2 rounded-full bg-primary px-3 py-1 text-xs font-medium text-primary-foreground">
                인기
              </span>
            )}

            {/* Selected indicator */}
            {selectedPackage === key && (
              <div className="absolute right-3 top-3 rounded-full bg-primary p-1">
                <Check className="h-3 w-3 text-primary-foreground" />
              </div>
            )}

            {/* Package name */}
            <h3 className="text-lg font-semibold">{pkg.name}</h3>
            <p className="mt-1 text-sm text-muted-foreground">{pkg.description}</p>

            {/* Credits */}
            <div className="mt-4">
              <span className="text-3xl font-bold">{pkg.credits}</span>
              <span className="ml-1 text-muted-foreground">크레딧</span>
            </div>

            {/* Price */}
            <div className="mt-2">
              <span className="text-2xl font-semibold">${pkg.priceUsd}</span>
              <span className="ml-1 text-sm text-muted-foreground">USD</span>
            </div>

            {/* Price per credit */}
            <p className="mt-2 text-xs text-muted-foreground">
              크레딧당 ${(pkg.priceUsd / pkg.credits).toFixed(2)}
            </p>
          </button>
        )
      )}
    </div>
  );
}
```

**Verification:**
- [ ] lucide-react 아이콘 import 확인
- [ ] cn 유틸리티 import 확인

---

### Task 4: PurchaseButton 컴포넌트 (Lemon.js Overlay)

**File to create:**
- `src/features/purchase/ui/PurchaseButton.tsx`

**Implementation:**

```typescript
// src/features/purchase/ui/PurchaseButton.tsx
'use client';

import { useState, useEffect } from 'react';
import Script from 'next/script';
import { Button } from '@/src/shared/ui/button';
import { createCreditCheckout } from '../api/create-checkout';
import type { CreditPackage } from '@/src/entities';
import type { LemonSqueezyEvent } from '@/src/shared/lib/lemon-squeezy/lemon-types';

interface PurchaseButtonProps {
  packageKey: CreditPackage | null;
  onSuccess?: () => void;
  onError?: (error: string) => void;
  disabled?: boolean;
}

export function PurchaseButton({
  packageKey,
  onSuccess,
  onError,
  disabled = false,
}: PurchaseButtonProps) {
  const [isLoading, setIsLoading] = useState(false);
  const [scriptLoaded, setScriptLoaded] = useState(false);

  // Setup event handler when script loads
  useEffect(() => {
    if (!scriptLoaded || typeof window === 'undefined') return;

    // Initialize Lemon Squeezy with event handler
    window.LemonSqueezy?.Setup({
      eventHandler: (event: LemonSqueezyEvent) => {
        if (event.event === 'Checkout.Success') {
          onSuccess?.();
        }
      },
    });
  }, [scriptLoaded, onSuccess]);

  async function handlePurchase() {
    if (!packageKey) {
      onError?.('패키지를 선택해주세요.');
      return;
    }

    setIsLoading(true);

    try {
      const result = await createCreditCheckout(packageKey);

      if (!result.success) {
        onError?.(result.error);
        return;
      }

      // Open Lemon Squeezy checkout overlay
      if (window.LemonSqueezy?.Url?.Open) {
        window.LemonSqueezy.Url.Open(result.checkoutUrl);
      } else {
        // Fallback: open in new tab
        window.open(result.checkoutUrl, '_blank');
      }
    } catch (err) {
      console.error('Purchase error:', err);
      onError?.('결제 처리 중 오류가 발생했습니다.');
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <>
      <Script
        src="https://assets.lemonsqueezy.com/lemon.js"
        strategy="lazyOnload"
        onLoad={() => {
          window.createLemonSqueezy?.();
          setScriptLoaded(true);
        }}
      />
      <Button
        onClick={handlePurchase}
        disabled={disabled || !packageKey || isLoading}
        size="lg"
        className="w-full sm:w-auto"
      >
        {isLoading ? '처리 중...' : '크레딧 구매하기'}
      </Button>
    </>
  );
}
```

**Verification:**
- [ ] next/script import 확인
- [ ] Button 컴포넌트 경로 확인

---

### Task 5: CreditBalance 컴포넌트

**File to create:**
- `src/features/purchase/ui/CreditBalance.tsx`

**Implementation:**

```typescript
// src/features/purchase/ui/CreditBalance.tsx
'use client';

import { Coins } from 'lucide-react';
import { cn } from '@/src/shared/lib/utils';

interface CreditBalanceProps {
  credits: number;
  size?: 'sm' | 'md' | 'lg';
  showIcon?: boolean;
  className?: string;
}

export function CreditBalance({
  credits,
  size = 'md',
  showIcon = true,
  className,
}: CreditBalanceProps) {
  const sizes = {
    sm: {
      container: 'px-2 py-1',
      text: 'text-sm',
      icon: 'h-3 w-3',
    },
    md: {
      container: 'px-3 py-1.5',
      text: 'text-base',
      icon: 'h-4 w-4',
    },
    lg: {
      container: 'px-4 py-2',
      text: 'text-lg',
      icon: 'h-5 w-5',
    },
  };

  const s = sizes[size];

  return (
    <div
      className={cn(
        'inline-flex items-center gap-2 rounded-lg bg-primary/10',
        s.container,
        className
      )}
    >
      {showIcon && <Coins className={cn('text-primary', s.icon)} />}
      <span className={cn('font-semibold text-primary', s.text)}>
        {credits.toLocaleString()}
      </span>
      <span className={cn('text-muted-foreground', s.text)}>크레딧</span>
    </div>
  );
}
```

**Verification:**
- [ ] lucide-react Coins 아이콘 확인

---

### Task 6: 구매 페이지 생성

**File to create:**
- `app/(protected)/purchase/page.tsx`

**Implementation:**

```typescript
// app/(protected)/purchase/page.tsx
'use client';

import { useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { CreditPackages } from '@/src/features/purchase/ui/CreditPackages';
import { PurchaseButton } from '@/src/features/purchase/ui/PurchaseButton';
import { CreditBalance } from '@/src/features/purchase/ui/CreditBalance';
import { useUser } from '@/src/features/auth/hooks/use-user';
import type { CreditPackage } from '@/src/entities';

export default function PurchasePage() {
  const router = useRouter();
  const { profile, isLoading: isUserLoading, refetch } = useUser();
  const [selectedPackage, setSelectedPackage] = useState<CreditPackage | null>(null);
  const [error, setError] = useState<string | null>(null);

  const handleSuccess = useCallback(async () => {
    // Refresh user profile to get updated credits
    await refetch();
    // Redirect to dashboard with success message
    router.push('/dashboard?purchase=success');
  }, [refetch, router]);

  const handleError = useCallback((errorMessage: string) => {
    setError(errorMessage);
  }, []);

  if (isUserLoading) {
    return (
      <div className="flex min-h-[50vh] items-center justify-center">
        <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-5xl">
      {/* Header */}
      <div className="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-3xl font-bold">크레딧 구매</h1>
          <p className="mt-2 text-muted-foreground">
            PRD 생성에 필요한 크레딧을 구매하세요.
          </p>
        </div>
        <CreditBalance credits={profile?.credits ?? 0} size="lg" />
      </div>

      {/* Error message */}
      {error && (
        <div className="mb-6 rounded-lg bg-destructive/10 p-4 text-destructive">
          {error}
          <button
            onClick={() => setError(null)}
            className="ml-4 text-sm underline"
          >
            닫기
          </button>
        </div>
      )}

      {/* Package selection */}
      <div className="mb-8">
        <h2 className="mb-4 text-lg font-semibold">패키지 선택</h2>
        <CreditPackages
          selectedPackage={selectedPackage}
          onSelect={setSelectedPackage}
        />
      </div>

      {/* Credit usage info */}
      <div className="mb-8 rounded-lg border bg-muted/30 p-4">
        <h3 className="font-medium">크레딧 사용 안내</h3>
        <ul className="mt-2 space-y-1 text-sm text-muted-foreground">
          <li>• 기본 PRD 생성: 1 크레딧</li>
          <li>• 상세 PRD 생성: 3 크레딧</li>
          <li>• 크레딧은 유효기간 없이 영구 사용 가능합니다.</li>
        </ul>
      </div>

      {/* Purchase button */}
      <div className="flex justify-center">
        <PurchaseButton
          packageKey={selectedPackage}
          onSuccess={handleSuccess}
          onError={handleError}
        />
      </div>

      {/* Footer note */}
      <p className="mt-8 text-center text-sm text-muted-foreground">
        결제는 Lemon Squeezy를 통해 안전하게 처리됩니다.
        <br />
        문의사항은 support@ideatoprd.com으로 연락해주세요.
      </p>
    </div>
  );
}
```

**Verification:**
- [ ] 보호된 라우트 그룹 내 위치 확인 ((protected))
- [ ] useRouter import 확인

---

### Task 7: Feature barrel export 업데이트

**File to modify:**
- `src/features/purchase/ui/index.ts`
- `src/features/purchase/index.ts`

**Implementation:**

```typescript
// src/features/purchase/ui/index.ts
export { CreditPackages } from './CreditPackages';
export { PurchaseButton } from './PurchaseButton';
export { CreditBalance } from './CreditBalance';
```

```typescript
// src/features/purchase/index.ts (update)
export { CREDIT_PACKAGES, type CreditPackageConfig } from './model';
export { getPackageByVariantId } from './model';
export { CreditPackages, PurchaseButton, CreditBalance } from './ui';
// Server action: import directly from ./api/create-checkout in server contexts
```

**Verification:**
- [ ] barrel export 경로 확인

---

## Checkpoint: Build Verification

```bash
npm run build
```

**Expected outcome:**
- 빌드 성공
- 타입 에러 없음

**Human verification needed:**
1. `npm run dev` 실행
2. `/purchase` 페이지 접속
3. 패키지 선택 UI 확인
4. 구매 버튼 클릭 시 Lemon.js 오버레이 표시 확인 (환경 변수 설정 필요)

---

## Files Summary

### Created
- `src/features/purchase/api/create-checkout.ts`
- `src/shared/lib/lemon-squeezy/lemon-types.d.ts`
- `src/features/purchase/ui/CreditPackages.tsx`
- `src/features/purchase/ui/PurchaseButton.tsx`
- `src/features/purchase/ui/CreditBalance.tsx`
- `src/features/purchase/ui/index.ts`
- `app/(protected)/purchase/page.tsx`

### Modified
- `src/features/purchase/index.ts`

---

## Notes

- Lemon.js 스크립트는 lazyOnload로 로드하여 초기 로딩 성능에 영향 없음
- 오버레이 실패 시 새 탭에서 결제 페이지 열기로 fallback
- 결제 성공 후 대시보드로 리다이렉트하며 크레딧 자동 갱신
