---
phase: 06-credit-system
plan: 03
title: Credit Modals + Dashboard Integration
depends_on: [06-02]
parallel: false
ai_context: |
  Phase 6 세 번째 플랜: 크레딧 부족 모달, 구매 히스토리, 대시보드 통합.
  PRD 생성 페이지에서 크레딧 부족 시 모달 표시, 헤더에 크레딧 잔액 표시.
---

# 06-03: Credit Modals + Dashboard Integration

## Overview

크레딧 부족 시 구매 유도 모달, 구매 히스토리 조회, 헤더/대시보드에 크레딧 잔액 표시. PRD 생성 플로우와 크레딧 시스템을 자연스럽게 통합합니다.

## Prerequisites

- Plan 06-02 완료 (Checkout Flow, Purchase UI)

## Tasks

### Task 1: InsufficientCreditsModal 컴포넌트

**File to create:**
- `src/features/purchase/ui/InsufficientCreditsModal.tsx`

**Implementation:**

```typescript
// src/features/purchase/ui/InsufficientCreditsModal.tsx
'use client';

import { useRouter } from 'next/navigation';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/src/shared/ui/dialog';
import { Button } from '@/src/shared/ui/button';
import { AlertCircle, ShoppingCart } from 'lucide-react';

interface InsufficientCreditsModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  currentCredits: number;
  requiredCredits: number;
}

export function InsufficientCreditsModal({
  open,
  onOpenChange,
  currentCredits,
  requiredCredits,
}: InsufficientCreditsModalProps) {
  const router = useRouter();
  const deficit = requiredCredits - currentCredits;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
            <AlertCircle className="h-6 w-6 text-destructive" />
          </div>
          <DialogTitle className="text-center">크레딧이 부족합니다</DialogTitle>
          <DialogDescription className="text-center">
            PRD 생성에 <strong>{requiredCredits} 크레딧</strong>이 필요하지만,
            현재 <strong>{currentCredits} 크레딧</strong>을 보유하고 있습니다.
            <br />
            <span className="text-destructive">
              {deficit} 크레딧이 더 필요합니다.
            </span>
          </DialogDescription>
        </DialogHeader>

        <div className="mt-4 rounded-lg bg-muted/50 p-4 text-center">
          <p className="text-sm text-muted-foreground">
            크레딧을 구매하면 바로 PRD를 생성할 수 있습니다.
          </p>
        </div>

        <DialogFooter className="mt-6 flex-col gap-2 sm:flex-row">
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            className="w-full sm:w-auto"
          >
            취소
          </Button>
          <Button
            onClick={() => {
              onOpenChange(false);
              router.push('/purchase');
            }}
            className="w-full sm:w-auto"
          >
            <ShoppingCart className="mr-2 h-4 w-4" />
            크레딧 구매하기
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Verification:**
- [ ] Dialog 컴포넌트 import 확인 (shadcn/ui)
- [ ] lucide-react 아이콘 확인

---

### Task 2: PRD 생성 페이지에 크레딧 모달 통합

**File to modify:**
- `app/(protected)/generate/page.tsx`

**Changes:**
- 크레딧 부족 시 InsufficientCreditsModal 표시
- 402 에러 시 모달 오픈

**Implementation:**

```typescript
// app/(protected)/generate/page.tsx (update)
'use client';

import { useState, useCallback } from 'react';
import { PRDForm, PRDViewer, CREDITS_PER_VERSION } from '@/src/features/prd-generation';
import type { PRDTemplate, PRDVersion } from '@/src/entities';
import { useUser } from '@/src/features/auth/hooks/use-user';
import { InsufficientCreditsModal } from '@/src/features/purchase/ui/InsufficientCreditsModal';
import { CreditBalance } from '@/src/features/purchase/ui/CreditBalance';

export default function GeneratePage() {
  const { profile, isLoading: isUserLoading, refetch } = useUser();
  const [content, setContent] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Credit modal state
  const [showCreditModal, setShowCreditModal] = useState(false);
  const [requiredCredits, setRequiredCredits] = useState(0);

  const handleGenerate = useCallback(
    async (data: {
      idea: string;
      template: PRDTemplate;
      version: PRDVersion;
    }) => {
      // Check credits before generating
      const creditsNeeded = CREDITS_PER_VERSION[data.version];
      const currentCredits = profile?.credits ?? 0;

      if (currentCredits < creditsNeeded) {
        setRequiredCredits(creditsNeeded);
        setShowCreditModal(true);
        return;
      }

      setIsGenerating(true);
      setContent('');
      setError(null);

      try {
        const response = await fetch('/api/generate-prd', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errorData = await response.json();

          // Handle insufficient credits (402)
          if (response.status === 402) {
            setRequiredCredits(creditsNeeded);
            setShowCreditModal(true);
            return;
          }

          throw new Error(errorData.error || 'PRD 생성에 실패했습니다.');
        }

        // Handle streaming response
        const reader = response.body?.getReader();
        const decoder = new TextDecoder();

        if (!reader) {
          throw new Error('스트리밍을 시작할 수 없습니다.');
        }

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          setContent((prev) => prev + chunk);
        }

        // Refresh user profile to update credits
        await refetch();
      } catch (err) {
        setError(
          err instanceof Error ? err.message : 'PRD 생성 중 오류가 발생했습니다.'
        );
      } finally {
        setIsGenerating(false);
      }
    },
    [profile?.credits, refetch]
  );

  if (isUserLoading) {
    return (
      <div className="flex min-h-[50vh] items-center justify-center">
        <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-6xl">
      <div className="mb-8 flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">PRD 생성</h1>
          <p className="mt-2 text-muted-foreground">
            아이디어를 입력하면 AI가 PRD를 자동으로 생성합니다.
          </p>
        </div>
        <CreditBalance credits={profile?.credits ?? 0} size="lg" />
      </div>

      {error && (
        <div className="mb-6 rounded-lg bg-destructive/10 p-4 text-destructive">
          {error}
        </div>
      )}

      <div className="grid gap-8 lg:grid-cols-2">
        {/* Left: Form */}
        <div>
          <PRDForm
            onSubmit={handleGenerate}
            isLoading={isGenerating}
            userCredits={profile?.credits ?? 0}
          />
        </div>

        {/* Right: Viewer */}
        <div>
          <PRDViewer content={content} isStreaming={isGenerating} />
        </div>
      </div>

      {/* Insufficient Credits Modal */}
      <InsufficientCreditsModal
        open={showCreditModal}
        onOpenChange={setShowCreditModal}
        currentCredits={profile?.credits ?? 0}
        requiredCredits={requiredCredits}
      />
    </div>
  );
}
```

**Verification:**
- [ ] CREDITS_PER_VERSION export 확인
- [ ] 모달 import 경로 확인

---

### Task 3: 구매 히스토리 조회 함수

**File to create:**
- `src/features/purchase/api/get-purchases.ts`

**Implementation:**

```typescript
// src/features/purchase/api/get-purchases.ts
import { createClient } from '@/src/shared/lib/supabase/server';
import type { Purchase } from '@/src/entities';

export interface PurchaseWithDetails extends Purchase {
  packageName: string;
}

export async function getUserPurchases(): Promise<PurchaseWithDetails[]> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return [];
  }

  const { data, error } = await supabase
    .from('purchases')
    .select('*')
    .eq('user_id', user.id)
    .eq('status', 'completed')
    .order('created_at', { ascending: false })
    .limit(50);

  if (error) {
    console.error('Failed to fetch purchases:', error);
    return [];
  }

  // Map package enum to display name
  const packageNames: Record<string, string> = {
    starter: 'Starter',
    basic: 'Basic',
    pro: 'Pro',
    business: 'Business',
  };

  return (data ?? []).map((purchase) => ({
    ...purchase,
    packageName: packageNames[purchase.package] || purchase.package,
  }));
}
```

**Verification:**
- [ ] Purchase 타입 확인
- [ ] server createClient 사용 확인

---

### Task 4: PurchaseHistory 컴포넌트

**File to create:**
- `src/features/purchase/ui/PurchaseHistory.tsx`

**Implementation:**

```typescript
// src/features/purchase/ui/PurchaseHistory.tsx
import type { PurchaseWithDetails } from '../api/get-purchases';
import { formatDistanceToNow } from 'date-fns';
import { ko } from 'date-fns/locale';
import { Receipt } from 'lucide-react';

interface PurchaseHistoryProps {
  purchases: PurchaseWithDetails[];
}

export function PurchaseHistory({ purchases }: PurchaseHistoryProps) {
  if (purchases.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center rounded-lg border border-dashed p-8 text-center">
        <Receipt className="mb-4 h-12 w-12 text-muted-foreground/50" />
        <p className="text-muted-foreground">구매 내역이 없습니다.</p>
      </div>
    );
  }

  return (
    <div className="divide-y rounded-lg border">
      {purchases.map((purchase) => (
        <div
          key={purchase.id}
          className="flex items-center justify-between p-4"
        >
          <div>
            <p className="font-medium">{purchase.packageName} 패키지</p>
            <p className="text-sm text-muted-foreground">
              +{purchase.credits_amount} 크레딧
            </p>
          </div>
          <div className="text-right">
            <p className="font-medium">
              ${(purchase.amount_cents / 100).toFixed(2)}{' '}
              <span className="text-xs text-muted-foreground">
                {purchase.currency.toUpperCase()}
              </span>
            </p>
            <p className="text-sm text-muted-foreground">
              {formatDistanceToNow(new Date(purchase.created_at), {
                addSuffix: true,
                locale: ko,
              })}
            </p>
          </div>
        </div>
      ))}
    </div>
  );
}
```

**Verification:**
- [ ] date-fns 설치 확인 (필요시 npm install date-fns)
- [ ] lucide-react Receipt 아이콘 확인

---

### Task 5: 헤더에 크레딧 잔액 표시

**File to modify:**
- `src/features/auth/ui/UserMenu.tsx`

**Changes:**
- 크레딧 잔액 표시 추가
- 구매 페이지 링크 추가

**Implementation (key changes):**

```typescript
// UserMenu.tsx에 추가할 내용

// Import 추가
import { Coins, ShoppingCart } from 'lucide-react';
import Link from 'next/link';

// DropdownMenuContent 내부에 추가 (로그아웃 버튼 위에)
<DropdownMenuSeparator />
<div className="px-2 py-1.5">
  <div className="flex items-center gap-2 text-sm">
    <Coins className="h-4 w-4 text-primary" />
    <span className="font-medium">{profile?.credits ?? 0}</span>
    <span className="text-muted-foreground">크레딧</span>
  </div>
</div>
<DropdownMenuItem asChild>
  <Link href="/purchase" className="cursor-pointer">
    <ShoppingCart className="mr-2 h-4 w-4" />
    크레딧 구매
  </Link>
</DropdownMenuItem>
<DropdownMenuSeparator />
```

**Verification:**
- [ ] UserMenu에 profile props 전달되는지 확인
- [ ] Link import 확인

---

### Task 6: UI barrel export 업데이트

**File to modify:**
- `src/features/purchase/ui/index.ts`

**Implementation:**

```typescript
// src/features/purchase/ui/index.ts (update)
export { CreditPackages } from './CreditPackages';
export { PurchaseButton } from './PurchaseButton';
export { CreditBalance } from './CreditBalance';
export { InsufficientCreditsModal } from './InsufficientCreditsModal';
export { PurchaseHistory } from './PurchaseHistory';
```

**Verification:**
- [ ] 모든 컴포넌트 export 확인

---

### Task 7: 환경 변수 문서화

**File to modify:**
- `.env.example`

**Implementation:**

```env
# Lemon Squeezy Configuration
# Get these from https://app.lemonsqueezy.com/settings/api

# API Key (Settings > API)
LEMONSQUEEZY_API_KEY=your_api_key_here

# Store ID (visible in store URL: https://app.lemonsqueezy.com/stores/XXXXX)
LEMONSQUEEZY_STORE_ID=your_store_id_here

# Webhook Secret (Settings > Webhooks > Create webhook)
LEMONSQUEEZY_WEBHOOK_SECRET=your_webhook_secret_here

# Variant IDs (Products > Select product > Variants)
# Create 4 products with these credit amounts: Starter(10), Basic(30), Pro(100), Business(300)
NEXT_PUBLIC_LS_VARIANT_STARTER=variant_id_for_starter
NEXT_PUBLIC_LS_VARIANT_BASIC=variant_id_for_basic
NEXT_PUBLIC_LS_VARIANT_PRO=variant_id_for_pro
NEXT_PUBLIC_LS_VARIANT_BUSINESS=variant_id_for_business
```

**Verification:**
- [ ] .env.example에 모든 필수 변수 포함

---

## Checkpoint: Build & Manual Verification

```bash
npm run build
```

**Expected outcome:**
- 빌드 성공
- 타입 에러 없음

**Human verification needed:**

### 설정 단계 (배포 전)
1. Lemon Squeezy 계정 생성 및 Store 설정
2. 4개 Product 생성 (Starter, Basic, Pro, Business)
3. 각 Product의 Variant ID 복사
4. API Key 생성
5. Webhook 생성:
   - URL: `https://your-domain.com/api/webhook/lemon-squeezy`
   - Events: `order_created`
   - Secret 복사

### 테스트 단계
1. `npm run dev` 실행
2. `/generate` 페이지에서 크레딧 부족 상태로 PRD 생성 시도
   - → 크레딧 부족 모달 표시 확인
3. `/purchase` 페이지에서 패키지 선택 및 구매 버튼 클릭
   - → Lemon.js 오버레이 표시 확인 (환경 변수 설정 필요)
4. Test mode로 결제 완료
   - → 웹훅 수신 및 크레딧 충전 확인
5. 헤더 UserMenu에서 크레딧 잔액 표시 확인

---

## Files Summary

### Created
- `src/features/purchase/ui/InsufficientCreditsModal.tsx`
- `src/features/purchase/api/get-purchases.ts`
- `src/features/purchase/ui/PurchaseHistory.tsx`

### Modified
- `app/(protected)/generate/page.tsx` - 크레딧 모달 통합
- `src/features/auth/ui/UserMenu.tsx` - 크레딧 잔액 표시
- `src/features/purchase/ui/index.ts` - barrel export
- `.env.example` - 환경 변수 문서화

---

## Phase 6 Completion Checklist

Phase 6 완료 시 다음 기능이 작동해야 합니다:

- [ ] Lemon Squeezy SDK 초기화
- [ ] 웹훅 서명 검증
- [ ] 웹훅으로 크레딧 자동 충전
- [ ] 크레딧 패키지 선택 UI
- [ ] Checkout Overlay 결제 플로우
- [ ] 크레딧 부족 시 구매 유도 모달
- [ ] 헤더에 크레딧 잔액 표시
- [ ] 구매 히스토리 조회

**Next Phase:** 07-dashboard (PRD 히스토리 + 내보내기)
