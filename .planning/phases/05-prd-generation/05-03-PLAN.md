---
phase: 05-prd-generation
plan: 03
type: execute
depends_on: ["05-02"]
files_modified:
  - src/app/api/generate-prd/route.ts
  - src/features/prd-generation/model/types.ts
  - src/features/prd-generation/index.ts
---

<objective>
PRD 생성 API Route Handler 구현 (스트리밍)

Purpose: Claude API를 활용한 PRD 스트리밍 생성 엔드포인트 구축
Output: POST /api/generate-prd 엔드포인트 (Edge Runtime, 스트리밍 응답)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-prd-generation/05-RESEARCH.md
@.planning/phases/05-prd-generation/05-01-SUMMARY.md
@.planning/phases/05-prd-generation/05-02-SUMMARY.md

# Claude 클라이언트
@src/shared/lib/ai/anthropic.ts

# 시스템 프롬프트 및 템플릿
@src/features/prd-generation/lib/prompts/system.ts

# DB 타입
@src/entities/index.ts

**Established patterns:**
- Route Handler (app/api/*/route.ts)
- streamText + toUIMessageStreamResponse
- Edge Runtime for low latency
</context>

<tasks>

<task type="auto">
  <name>Task 1: PRD 생성 요청/응답 타입 정의</name>
  <files>src/features/prd-generation/model/types.ts, src/features/prd-generation/index.ts</files>
  <action>
    1. src/features/prd-generation/model/types.ts 생성:
    ```typescript
    import type { PRDTemplate, PRDVersion } from '@/src/entities';

    // API Request
    export interface GeneratePRDRequest {
      idea: string;
      template: PRDTemplate;
      version: PRDVersion;
    }

    // For internal use
    export interface PRDGenerationContext {
      userId: string;
      idea: string;
      template: PRDTemplate;
      version: PRDVersion;
      creditsRequired: number;
    }

    // Credits required per version
    export const CREDITS_PER_VERSION: Record<PRDVersion, number> = {
      basic: 1,
      detailed: 2,
    };

    // Validation
    export const MAX_IDEA_LENGTH = 500;
    export const MIN_IDEA_LENGTH = 10;

    export function validateIdea(idea: string): { valid: boolean; error?: string } {
      if (!idea || idea.trim().length < MIN_IDEA_LENGTH) {
        return { valid: false, error: `아이디어는 최소 ${MIN_IDEA_LENGTH}자 이상이어야 합니다.` };
      }
      if (idea.length > MAX_IDEA_LENGTH) {
        return { valid: false, error: `아이디어는 ${MAX_IDEA_LENGTH}자를 초과할 수 없습니다.` };
      }
      return { valid: true };
    }
    ```

    2. src/features/prd-generation/index.ts 업데이트:
    ```typescript
    // ... existing exports
    export type { GeneratePRDRequest, PRDGenerationContext } from './model/types';
    export { CREDITS_PER_VERSION, validateIdea, MAX_IDEA_LENGTH, MIN_IDEA_LENGTH } from './model/types';
    ```

    주의:
    - PRDVersion enum 활용 (basic: 1크레딧, detailed: 2크레딧)
    - 입력 검증 로직 포함
  </action>
  <verify>TypeScript 컴파일 성공</verify>
  <done>타입 정의 및 검증 함수 완성</done>
</task>

<task type="auto">
  <name>Task 2: PRD 생성 API Route Handler</name>
  <files>src/app/api/generate-prd/route.ts</files>
  <action>
    src/app/api/generate-prd/route.ts 생성:
    ```typescript
    import { streamText } from 'ai';
    import { defaultModel, advancedModel, AI_CONFIG } from '@/src/shared/lib/ai/anthropic';
    import { getSystemPrompt } from '@/src/features/prd-generation';
    import { validateIdea, CREDITS_PER_VERSION } from '@/src/features/prd-generation';
    import type { PRDTemplate, PRDVersion } from '@/src/entities';
    import { createClient } from '@/src/shared/lib/supabase/server';

    export const runtime = 'edge';

    export async function POST(req: Request) {
      try {
        const { idea, template, version } = await req.json() as {
          idea: string;
          template: PRDTemplate;
          version: PRDVersion;
        };

        // 1. Validate input
        const validation = validateIdea(idea);
        if (!validation.valid) {
          return new Response(JSON.stringify({ error: validation.error }), {
            status: 400,
            headers: { 'Content-Type': 'application/json' },
          });
        }

        // 2. Authenticate user
        const supabase = await createClient();
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
          return new Response(JSON.stringify({ error: '로그인이 필요합니다.' }), {
            status: 401,
            headers: { 'Content-Type': 'application/json' },
          });
        }

        // 3. Check credits (will be fully implemented in Plan 05)
        const creditsRequired = CREDITS_PER_VERSION[version];
        // Note: Full credit check/deduction in Plan 05

        // 4. Select model based on version
        const model = version === 'detailed' ? advancedModel : defaultModel;

        // 5. Build prompt
        const systemPrompt = getSystemPrompt(template);
        const userPrompt = `
<user_input>
아이디어: ${idea}
버전: ${version === 'detailed' ? '상세 (Detailed)' : '기본 (Basic)'}
</user_input>

위 아이디어에 대한 PRD를 생성해주세요.
${version === 'basic' ? '핵심 섹션만 간략하게 작성해주세요.' : '모든 섹션을 상세하게 작성해주세요.'}
`;

        // 6. Stream response
        const result = streamText({
          model,
          system: systemPrompt,
          prompt: userPrompt,
          maxTokens: version === 'detailed' ? AI_CONFIG.maxTokens : 4096,
          temperature: AI_CONFIG.temperature,
          // Prompt caching for cost optimization
          experimental_providerMetadata: {
            anthropic: { cacheControl: { type: 'ephemeral' } },
          },
          onFinish: async ({ usage }) => {
            // Log usage for monitoring (full implementation in Plan 05)
            console.log('Token usage:', usage);
          },
        });

        return result.toTextStreamResponse();
      } catch (error) {
        console.error('PRD generation error:', error);
        return new Response(JSON.stringify({ error: 'PRD 생성 중 오류가 발생했습니다.' }), {
          status: 500,
          headers: { 'Content-Type': 'application/json' },
        });
      }
    }
    ```

    주의:
    - Edge Runtime 설정 (레이턴시 최소화)
    - 프롬프트 캐싱 활성화 (비용 90% 절감)
    - 사용자 입력을 <user_input> 태그로 감싸 프롬프트 인젝션 방지
    - 인증 체크 포함 (크레딧 차감은 Plan 05)
  </action>
  <verify>npm run build 성공, API route 파일 존재</verify>
  <done>스트리밍 API 엔드포인트 완성</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>PRD 생성 스트리밍 API 엔드포인트</what-built>
  <how-to-verify>
    1. .env.local에 ANTHROPIC_API_KEY 설정 확인
    2. npm run dev 실행
    3. 로그인 상태에서 curl 테스트:
       ```bash
       curl -X POST http://localhost:3000/api/generate-prd \
         -H "Content-Type: application/json" \
         -H "Cookie: [로그인 쿠키]" \
         -d '{"idea":"AI 기반 이력서 분석 서비스","template":"saas","version":"basic"}'
       ```
    4. 스트리밍 텍스트 응답 확인 (PRD 마크다운)
    5. 비로그인 시 401 응답 확인
    6. 짧은 아이디어(10자 미만) 시 400 응답 확인
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/app/api/generate-prd/route.ts 존재
- [ ] Edge Runtime 설정됨
- [ ] 스트리밍 응답 작동
- [ ] 인증 체크 작동
- [ ] 입력 검증 작동
- [ ] npm run build 성공
</verification>

<success_criteria>
- POST /api/generate-prd 엔드포인트 작동
- 스트리밍 응답 (텍스트가 점진적으로 출력)
- 인증 필수 (401 for unauthenticated)
- 입력 검증 (400 for invalid input)
- 프롬프트 캐싱 활성화
</success_criteria>

<output>
After completion, create `.planning/phases/05-prd-generation/05-03-SUMMARY.md`
</output>
