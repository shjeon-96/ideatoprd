---
phase: 05-prd-generation
plan: 05
type: execute
depends_on: ["05-04"]
files_modified:
  - src/app/api/generate-prd/route.ts
  - src/features/prd-generation/api/save-prd.ts
  - src/features/prd-generation/index.ts
  - src/app/(protected)/generate/page.tsx
---

<objective>
크레딧 차감 및 PRD DB 저장 통합

Purpose: PRD 생성 시 크레딧 원자적 차감 + 생성된 PRD를 데이터베이스에 저장
Output: 완전한 PRD 생성 플로우 (크레딧 체크 → 차감 → 생성 → 저장)
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-prd-generation/05-RESEARCH.md
@.planning/phases/05-prd-generation/05-04-SUMMARY.md

# Phase 4 크레딧 함수
@.planning/phases/04-database/04-03-SUMMARY.md

# API Route
@src/app/api/generate-prd/route.ts

# Supabase 클라이언트
@src/shared/lib/supabase/server.ts

# DB 타입
@src/entities/index.ts

**Constraining decisions:**
- Phase 4: deduct_credit(), add_credit() PostgreSQL 함수 구현됨
- Phase 4: FOR UPDATE row locking으로 원자적 트랜잭션
</context>

<tasks>

<task type="auto">
  <name>Task 1: PRD 저장 API 함수</name>
  <files>src/features/prd-generation/api/save-prd.ts, src/features/prd-generation/index.ts</files>
  <action>
    1. src/features/prd-generation/api/save-prd.ts:
    ```typescript
    import { createClient } from '@/src/shared/lib/supabase/server';
    import type { PRDInsert, PRD } from '@/src/entities';

    interface SavePRDParams {
      userId: string;
      idea: string;
      template: PRDInsert['template'];
      version: PRDInsert['version'];
      title: string;
      content: object;
      creditsUsed: number;
    }

    export async function savePRD(params: SavePRDParams): Promise<PRD | null> {
      const supabase = await createClient();

      const { data, error } = await supabase
        .from('prds')
        .insert({
          user_id: params.userId,
          idea: params.idea,
          template: params.template,
          version: params.version,
          title: params.title,
          content: params.content,
          credits_used: params.creditsUsed,
        })
        .select()
        .single();

      if (error) {
        console.error('Failed to save PRD:', error);
        return null;
      }

      return data;
    }

    // Extract title from PRD content (first H1 heading)
    export function extractPRDTitle(content: string): string {
      const match = content.match(/^#\s+(.+)$/m);
      return match?.[1] || '새 PRD';
    }

    // Parse PRD sections for structured storage
    export function parsePRDContent(content: string): object {
      return {
        raw: content,
        generatedAt: new Date().toISOString(),
      };
    }
    ```

    2. src/features/prd-generation/index.ts 업데이트:
    ```typescript
    // ... existing exports
    export { savePRD, extractPRDTitle, parsePRDContent } from './api/save-prd';
    ```

    주의:
    - content는 JSONB 컬럼 (raw 마크다운 + 메타데이터)
    - 제목은 PRD 첫 번째 H1 헤딩에서 추출
  </action>
  <verify>TypeScript 컴파일 성공</verify>
  <done>PRD 저장 함수 구현 완료</done>
</task>

<task type="auto">
  <name>Task 2: API Route에 크레딧 차감 + PRD 저장 통합</name>
  <files>src/app/api/generate-prd/route.ts</files>
  <action>
    src/app/api/generate-prd/route.ts 전체 업데이트:
    ```typescript
    import { streamText } from 'ai';
    import { defaultModel, advancedModel, AI_CONFIG } from '@/src/shared/lib/ai/anthropic';
    import { getSystemPrompt, CREDITS_PER_VERSION, validateIdea, savePRD, extractPRDTitle, parsePRDContent } from '@/src/features/prd-generation';
    import type { PRDTemplate, PRDVersion } from '@/src/entities';
    import { createClient } from '@/src/shared/lib/supabase/server';

    export const runtime = 'edge';

    export async function POST(req: Request) {
      let userId: string | null = null;
      let fullContent = '';

      try {
        const { idea, template, version } = await req.json() as {
          idea: string;
          template: PRDTemplate;
          version: PRDVersion;
        };

        // 1. Validate input
        const validation = validateIdea(idea);
        if (!validation.valid) {
          return new Response(JSON.stringify({ error: validation.error }), {
            status: 400,
            headers: { 'Content-Type': 'application/json' },
          });
        }

        // 2. Authenticate user
        const supabase = await createClient();
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
          return new Response(JSON.stringify({ error: '로그인이 필요합니다.' }), {
            status: 401,
            headers: { 'Content-Type': 'application/json' },
          });
        }
        userId = user.id;

        // 3. Deduct credits (atomic with FOR UPDATE lock)
        const creditsRequired = CREDITS_PER_VERSION[version];
        const { data: deductResult, error: deductError } = await supabase
          .rpc('deduct_credit', {
            p_user_id: userId,
            p_amount: creditsRequired,
            p_description: `PRD 생성: ${idea.slice(0, 50)}...`,
          });

        if (deductError || !deductResult) {
          console.error('Credit deduction failed:', deductError);
          return new Response(JSON.stringify({ error: '크레딧이 부족합니다.' }), {
            status: 402,
            headers: { 'Content-Type': 'application/json' },
          });
        }

        // 4. Select model based on version
        const model = version === 'detailed' ? advancedModel : defaultModel;

        // 5. Build prompt
        const systemPrompt = getSystemPrompt(template);
        const userPrompt = `
<user_input>
아이디어: ${idea}
버전: ${version === 'detailed' ? '상세 (Detailed)' : '기본 (Basic)'}
</user_input>

위 아이디어에 대한 PRD를 생성해주세요.
${version === 'basic' ? '핵심 섹션만 간략하게 작성해주세요.' : '모든 섹션을 상세하게 작성해주세요.'}
`;

        // 6. Stream response with content accumulation
        const result = streamText({
          model,
          system: systemPrompt,
          prompt: userPrompt,
          maxTokens: version === 'detailed' ? AI_CONFIG.maxTokens : 4096,
          temperature: AI_CONFIG.temperature,
          experimental_providerMetadata: {
            anthropic: { cacheControl: { type: 'ephemeral' } },
          },
          onChunk: ({ chunk }) => {
            if (chunk.type === 'text-delta') {
              fullContent += chunk.textDelta;
            }
          },
          onFinish: async ({ usage }) => {
            // Save PRD to database
            if (userId && fullContent) {
              try {
                await savePRD({
                  userId,
                  idea,
                  template,
                  version,
                  title: extractPRDTitle(fullContent),
                  content: parsePRDContent(fullContent),
                  creditsUsed: creditsRequired,
                });
                console.log('PRD saved successfully. Tokens:', usage);
              } catch (saveError) {
                console.error('Failed to save PRD:', saveError);
                // Note: Credit already deducted, PRD was generated
                // Consider refund logic for production
              }
            }
          },
        });

        return result.toTextStreamResponse();
      } catch (error) {
        console.error('PRD generation error:', error);

        // If credit was deducted but generation failed, consider refund
        // For MVP, log the error and notify user
        return new Response(JSON.stringify({ error: 'PRD 생성 중 오류가 발생했습니다.' }), {
          status: 500,
          headers: { 'Content-Type': 'application/json' },
        });
      }
    }
    ```

    주의:
    - 크레딧 먼저 차감 (deduct_credit RPC)
    - 402 Payment Required for 크레딧 부족
    - onChunk로 전체 콘텐츠 누적
    - onFinish에서 DB 저장
    - 에러 시 로깅 (MVP에서는 자동 환불 미구현)
  </action>
  <verify>npm run build 성공</verify>
  <done>크레딧 차감 + PRD 저장 통합 완료</done>
</task>

<task type="auto">
  <name>Task 3: 페이지에서 크레딧 실시간 업데이트</name>
  <files>src/app/(protected)/generate/page.tsx</files>
  <action>
    src/app/(protected)/generate/page.tsx 업데이트 - 생성 완료 후 크레딧 갱신:
    ```typescript
    'use client';

    import { useState, useCallback } from 'react';
    import { PRDForm, PRDViewer, CREDITS_PER_VERSION } from '@/src/features/prd-generation';
    import type { PRDTemplate, PRDVersion } from '@/src/entities';
    import { useUser } from '@/src/features/auth';

    export default function GeneratePage() {
      const { profile, isLoading: isUserLoading, refetch } = useUser();
      const [content, setContent] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [generatedPRDId, setGeneratedPRDId] = useState<string | null>(null);

      const handleGenerate = useCallback(async (data: {
        idea: string;
        template: PRDTemplate;
        version: PRDVersion;
      }) => {
        setIsGenerating(true);
        setContent('');
        setError(null);
        setGeneratedPRDId(null);

        try {
          const response = await fetch('/api/generate-prd', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'PRD 생성에 실패했습니다.');
          }

          // Handle streaming response
          const reader = response.body?.getReader();
          const decoder = new TextDecoder();

          if (!reader) {
            throw new Error('스트리밍을 시작할 수 없습니다.');
          }

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            setContent((prev) => prev + chunk);
          }

          // Refresh user profile to update credits
          await refetch();

        } catch (err) {
          setError(err instanceof Error ? err.message : 'PRD 생성 중 오류가 발생했습니다.');
        } finally {
          setIsGenerating(false);
        }
      }, [refetch]);

      if (isUserLoading) {
        return (
          <div className="flex min-h-[50vh] items-center justify-center">
            <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
          </div>
        );
      }

      return (
        <div className="container mx-auto max-w-6xl px-4 py-8">
          <div className="mb-8 flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold">PRD 생성</h1>
              <p className="mt-2 text-muted-foreground">
                아이디어를 입력하면 AI가 PRD를 자동으로 생성합니다.
              </p>
            </div>
            <div className="rounded-lg bg-primary/10 px-4 py-2">
              <span className="text-sm text-muted-foreground">보유 크레딧</span>
              <span className="ml-2 text-lg font-bold text-primary">{profile?.credits ?? 0}</span>
            </div>
          </div>

          {error && (
            <div className="mb-6 rounded-lg bg-destructive/10 p-4 text-destructive">
              {error}
            </div>
          )}

          <div className="grid gap-8 lg:grid-cols-2">
            {/* Left: Form */}
            <div>
              <PRDForm
                onSubmit={handleGenerate}
                isLoading={isGenerating}
                userCredits={profile?.credits ?? 0}
              />
            </div>

            {/* Right: Viewer */}
            <div>
              <PRDViewer content={content} isStreaming={isGenerating} />
            </div>
          </div>
        </div>
      );
    }
    ```

    주의:
    - refetch() 호출로 크레딧 실시간 갱신
    - 우측 상단에 현재 크레딧 표시
    - useUser hook에 refetch 함수 필요 (없으면 추가)
  </action>
  <verify>npm run build 성공</verify>
  <done>크레딧 실시간 업데이트 구현 완료</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>완전한 PRD 생성 플로우 (크레딧 차감 → 생성 → DB 저장)</what-built>
  <how-to-verify>
    1. npm run dev 실행
    2. Supabase Dashboard에서 테스트 유저 크레딧 확인 (profiles 테이블)
    3. /generate 페이지 접속
    4. PRD 생성 실행
    5. 확인 사항:
       a) 크레딧 차감 확인:
          - Supabase profiles 테이블에서 credits 감소 확인
          - 페이지 우측 상단 크레딧 실시간 갱신
       b) PRD 저장 확인:
          - Supabase prds 테이블에 새 레코드 생성
          - idea, template, version, title, content 저장됨
       c) usage_logs 확인:
          - 크레딧 차감 로그 생성됨 (usage_type: 'prd_generation')
    6. 크레딧 부족 시:
       - 402 에러 응답
       - "크레딧이 부족합니다" 메시지
    7. 비로그인 시:
       - 401 에러 응답
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 크레딧 차감 작동 (deduct_credit RPC)
- [ ] 크레딧 부족 시 402 응답
- [ ] PRD가 prds 테이블에 저장됨
- [ ] usage_logs에 차감 로그 생성
- [ ] 페이지에서 크레딧 실시간 갱신
- [ ] npm run build 성공
</verification>

<success_criteria>
- 크레딧 원자적 차감 (FOR UPDATE lock)
- 생성된 PRD 데이터베이스 저장
- 사용 로그 기록
- 크레딧 실시간 UI 반영
- Phase 5 전체 완료
</success_criteria>

<output>
After completion, create `.planning/phases/05-prd-generation/05-05-SUMMARY.md` with:

**Phase 5 complete:**
- AI SDK + Claude 클라이언트 설정
- 5개 PRD 템플릿 프롬프트
- 스트리밍 API 엔드포인트
- PRD 생성 UI (폼 + 뷰어)
- 크레딧 차감 + DB 저장 통합

**다음 Phase:** 06-credit-system (Lemon Squeezy 결제 통합)
</output>
