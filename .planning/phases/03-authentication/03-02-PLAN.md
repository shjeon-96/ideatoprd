---
phase: 03-authentication
plan: 02
type: execute
depends_on: ["03-01"]
files_modified:
  - middleware.ts
  - app/auth/callback/route.ts
  - app/auth/confirm/route.ts
---

<objective>
인증 미들웨어 및 Auth 콜백 라우트 구현

Purpose: 세션 자동 갱신, OAuth 콜백 처리, 이메일 확인 라우트
Output: 작동하는 미들웨어, /auth/callback 및 /auth/confirm 라우트
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-authentication/03-01-SUMMARY.md

**Tech from 03-01:**
- Supabase client utilities in src/shared/lib/supabase/
- updateSession() helper for middleware
- Server client with cookie handling

**Discovery findings:**
- Middleware must call updateSession() on every request for session refresh
- OAuth callback exchanges code for session via /auth/callback
- Email confirmation uses /auth/confirm with token_hash and type params
- Matcher config excludes static files and images
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication middleware</name>
  <files>middleware.ts</files>
  <action>
    Create root middleware.ts that:

    1. Import updateSession from src/shared/lib/supabase/middleware
    2. Call updateSession(request) on every matched request
    3. Return the response (may have updated cookies)

    Config:
    - matcher: Exclude _next/static, _next/image, favicon.ico, and common image extensions
    - Pattern: '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'

    IMPORTANT: This middleware handles session refresh, NOT route protection.
    Route protection happens in individual pages/layouts via auth checks.
  </action>
  <verify>
    - npm run dev starts without middleware errors
    - Check console for "Middleware refreshed session" logs (if added)
  </verify>
  <done>
    - middleware.ts exists at project root
    - updateSession called on matched routes
    - Static files excluded from middleware
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OAuth callback route</name>
  <files>app/auth/callback/route.ts</files>
  <action>
    Create GET route handler at /auth/callback that:

    1. Extract 'code' and 'next' from searchParams
    2. If code exists:
       - Create server Supabase client
       - Exchange code for session via supabase.auth.exchangeCodeForSession(code)
       - Redirect to 'next' param or '/' on success
    3. If error:
       - Redirect to /auth/error with error message

    This route handles:
    - Google OAuth redirect
    - Magic link email authentication
    - Any OAuth provider callback

    Pattern from @supabase/ssr docs:
    ```typescript
    const { searchParams } = new URL(request.url)
    const code = searchParams.get('code')
    const next = searchParams.get('next') ?? '/'

    if (code) {
      const supabase = createClient()
      const { error } = await supabase.auth.exchangeCodeForSession(code)
      if (!error) {
        return NextResponse.redirect(new URL(next, request.url))
      }
    }
    return NextResponse.redirect(new URL('/auth/error', request.url))
    ```
  </action>
  <verify>
    - Route exists at /auth/callback
    - TypeScript compiles without errors
  </verify>
  <done>
    - app/auth/callback/route.ts handles OAuth code exchange
    - Redirects to destination or error page
  </done>
</task>

<task type="auto">
  <name>Task 3: Create email confirmation route</name>
  <files>app/auth/confirm/route.ts</files>
  <action>
    Create GET route handler at /auth/confirm that:

    1. Extract 'token_hash', 'type', and 'next' from searchParams
    2. If token_hash and type exist:
       - Create server Supabase client
       - Verify OTP via supabase.auth.verifyOtp({ token_hash, type })
       - Redirect to 'next' param or '/' on success
    3. If error or missing params:
       - Redirect to /auth/error

    This route handles:
    - Email signup confirmation
    - Password reset confirmation
    - Email change confirmation

    Types: 'signup', 'recovery', 'email_change', 'email'
  </action>
  <verify>
    - Route exists at /auth/confirm
    - TypeScript compiles without errors
  </verify>
  <done>
    - app/auth/confirm/route.ts handles email verification
    - Supports all OTP types (signup, recovery, etc.)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] middleware.ts exists at root with correct matcher
- [ ] /auth/callback route handles OAuth code exchange
- [ ] /auth/confirm route handles email verification
- [ ] Dev server starts without errors (npm run dev)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Middleware refreshes sessions on every request
- Auth routes ready for OAuth and email flows
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-02-SUMMARY.md`
</output>
