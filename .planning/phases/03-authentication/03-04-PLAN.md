---
phase: 03-authentication
plan: 04
type: execute
depends_on: ["03-03"]
files_modified:
  - src/features/auth/ui/auth-guard.tsx
  - src/features/auth/hooks/use-user.ts
  - app/(protected)/layout.tsx
  - app/(protected)/dashboard/page.tsx
  - src/widgets/common/user-menu.tsx
---

<objective>
AuthGuard 컴포넌트 및 보호된 라우트 패턴 구현

Purpose: 인증된 사용자만 접근 가능한 페이지 보호, 사용자 메뉴
Output: AuthGuard, useUser hook, 보호된 라우트 레이아웃, 대시보드 플레이스홀더
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-authentication/03-03-SUMMARY.md

**Tech from previous phases:**
- Supabase server client for SSR auth checks
- Auth feature module in src/features/auth/
- shadcn/ui components
- Server Actions for signOut

**Patterns:**
- Use server-side auth check in layouts (Server Components)
- Redirect unauthenticated users before rendering
- Client-side hook for reactive user state
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useUser hook for client components</name>
  <files>
    src/features/auth/hooks/use-user.ts,
    src/features/auth/index.ts
  </files>
  <action>
    Create client-side hook for user state:

    1. use-user.ts:
       - 'use client' hook
       - Use createClient from src/shared/lib/supabase/client
       - useState for user, loading, error
       - useEffect to fetch user on mount via supabase.auth.getUser()
       - Subscribe to auth state changes via supabase.auth.onAuthStateChange()
       - Cleanup subscription on unmount
       - Return { user, loading, error, isAuthenticated }

    2. Update src/features/auth/index.ts:
       - Export useUser hook
       - Export all components and actions

    This hook is for client components that need reactive user state.
    Server components should use supabase.auth.getUser() directly.
  </action>
  <verify>
    - Hook compiles without errors
    - Exported from feature index
  </verify>
  <done>
    - useUser hook created with auth state subscription
    - Proper cleanup on unmount
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthGuard and protected layout</name>
  <files>
    src/features/auth/ui/auth-guard.tsx,
    app/(protected)/layout.tsx
  </files>
  <action>
    Create server-side auth protection:

    1. auth-guard.tsx (Server Component):
       - Async component that checks auth status
       - Uses createClient from src/shared/lib/supabase/server
       - Calls supabase.auth.getUser()
       - If not authenticated: redirect('/login')
       - If authenticated: render children
       - Export AuthGuard component

       Pattern:
       ```tsx
       export async function AuthGuard({ children }: { children: React.ReactNode }) {
         const supabase = await createClient()
         const { data: { user } } = await supabase.auth.getUser()

         if (!user) {
           redirect('/login')
         }

         return <>{children}</>
       }
       ```

    2. app/(protected)/layout.tsx:
       - Wrap children with AuthGuard
       - Add basic layout structure for protected pages
       - Include header with user info placeholder
       - This layout applies to all routes in (protected) group

    The (protected) route group will contain:
    - /dashboard (created in this plan)
    - /generate (Phase 5)
    - /history (Phase 7)
    - /settings (Phase 7)
  </action>
  <verify>
    - AuthGuard redirects when not authenticated
    - Protected layout renders for authenticated users
  </verify>
  <done>
    - AuthGuard server component with redirect
    - Protected route group layout
  </done>
</task>

<task type="auto">
  <name>Task 3: Create user menu and dashboard placeholder</name>
  <files>
    src/widgets/common/user-menu.tsx,
    src/widgets/common/index.ts,
    app/(protected)/dashboard/page.tsx
  </files>
  <action>
    Create user menu and basic dashboard:

    1. user-menu.tsx:
       - 'use client' component
       - Use useUser hook for user state
       - Display user email/avatar
       - Dropdown menu with:
         - 프로필 (link to /settings - placeholder)
         - 로그아웃 (calls signOut action)
       - Use shadcn/ui DropdownMenu if available, or simple popover
       - Loading state while fetching user

    2. src/widgets/common/index.ts:
       - Export UserMenu

    3. app/(protected)/dashboard/page.tsx:
       - Basic dashboard placeholder page
       - Welcome message with user email
       - "PRD 생성하기" button (links to /generate - placeholder)
       - Metadata: title "대시보드 | IdeaToPRD"

    Update header in protected layout to include UserMenu.
  </action>
  <verify>
    - Dashboard page renders for authenticated users
    - User menu shows email and logout option
  </verify>
  <done>
    - UserMenu component with dropdown
    - Dashboard placeholder page
    - Protected layout includes user menu
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete authentication flow:
    - Protected route group with AuthGuard
    - Dashboard placeholder page
    - User menu with logout

    NOTE: Testing requires Supabase project to be configured.
    If no Supabase credentials, verify structure only.
  </what-built>
  <how-to-verify>
    **Without Supabase credentials (structure check):**
    1. Run: npm run dev
    2. Visit: http://localhost:3000/dashboard
       - Should redirect to /login (no auth)
    3. Check file structure exists:
       - app/(protected)/layout.tsx
       - app/(protected)/dashboard/page.tsx
       - src/features/auth/ui/auth-guard.tsx
       - src/widgets/common/user-menu.tsx

    **With Supabase credentials (full test):**
    1. Set up Supabase project with Google OAuth
    2. Add credentials to .env.local
    3. Run: npm run dev
    4. Visit: /login, click Google OAuth
    5. After login, verify redirect to /dashboard
    6. Verify user email shows in menu
    7. Click 로그아웃, verify redirect to home

    Type "structure-only" if testing without Supabase.
    Type "approved" if full flow works.
  </how-to-verify>
  <resume-signal>Type "approved" or "structure-only", or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] AuthGuard redirects unauthenticated users
- [ ] Protected layout wraps dashboard
- [ ] UserMenu component renders
- [ ] Dashboard placeholder page exists
- [ ] Phase 3 complete (all plans executed)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verified auth flow (with or without Supabase)
- Phase 3: Authentication complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication/03-04-SUMMARY.md`

Update `.planning/STATE.md`:
- Phase: 3 of 7 (Authentication) ✓ COMPLETE
- Current focus: Phase 4 — Database
</output>
